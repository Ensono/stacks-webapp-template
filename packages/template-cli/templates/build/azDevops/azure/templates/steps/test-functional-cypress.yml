############################################################################################################
# desc: Runs the function (e2e) tests with Cypress
# params: Env vars, Node version, workingDirectory, build_number
# return: Publishes test results, screenshots and video recordings
# pre-reqs: dependency installation, build webapp
############################################################################################################

parameters:
  env_vars: {}
  workingDirectory: ''

steps:
  # Run tests with Jest
  - script: npm run test:cypress:compile
    displayName: 'Compile the Cypress tests'
    workingDirectory: ${{ parameters.workingDirectory }}

  # Run tests with Cypress
  - script: npm run test:cypress
    displayName: 'Start webapp server and run Cypress tests'
    workingDirectory: ${{ parameters.workingDirectory }}
    env:
      ${{ each var in parameters.env_vars }}:
        ${{ var.key }}: ${{ var.value }}

  # Publish CI test results
  - task: PublishTestResults@2
    inputs:
      testRunner: JUnit
      testResultsFiles: '**/*junit-test-report.xml'
      testRunTitle: 'Cypress Tests'
    displayName: 'Publish test results'
    condition: succeededOrFailed()

  # Publish the code coverage results
  - task: PublishCodeCoverageResults@1
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: '**/cobertura-coverage.xml'
