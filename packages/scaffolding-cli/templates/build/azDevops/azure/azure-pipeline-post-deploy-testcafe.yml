pool:
  vmImage: windows-2019

resources:
  pipelines:
    - pipeline: azure-pipeline-post-deploy-testcafe
      source: amido-stacks-ssr-app-new-k8s
      trigger:
        branches:
          include:
            - master
  repositories:
    - repository: templates
      type: github
      name: amido/stacks-pipeline-templates
      ref: refs/tags/v1.1.0
      endpoint: amidostacks

steps:
  - checkout: self
  - checkout: templates
  # Functional tests running on deployed webapp
  - template: azDevOps/azure/templates/v2/steps/test-functional-testcafe.yml@templates
    parameters:
      env_vars:
        APP_BASE_URL: "https://app.nonprod.amidostacks.com/web/stacks"
        MENU_API_URL: "http://dev.amidostacks.com/api/menu"
        APP_BASE_PATH: "/web/stacks"
        NODE_ENV: production
      workingDirectory: $(Agent.BuildDirectory)/s/$(self_repo)/test/testcafe
      testcafe_browser_list: "chrome,firefox"
