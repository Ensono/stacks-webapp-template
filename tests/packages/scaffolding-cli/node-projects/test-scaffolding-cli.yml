##################################################################################################################################
# Desc: 
# 
# Pre-reqs: 
##################################################################################################################################

pr: none

trigger:
  branches:
    include:
      - master

  paths:
    include:
      - 'packages/scaffolding-cli/templates/src/ssr/*'
      - 'packages/scaffolding-cli/templates/src/csr/*'

resources:
  repositories:
    - repository: templates
      type: github
      name: amido/stacks-pipeline-templates
      ref: refs/tags/v1.2.1
      endpoint: amidostacks # GitHub Service Connection

# NOTE: If you use both variables and variable groups, you'll have to use name/value syntax for the individual (non-grouped)
variables:
  company: amido
  project: stacks
  domain: cli

  self_repo: stacks-webapp-template/tests/packages/scaffolding-cli
  self_repo_src: node-projects
  self_generic_name: scaffolding-cli
  # scaffolding-cli
  scaffolding_config:
    ssr.bootstrap-config.json: yumidoexampleapp/src
    csr.bootstrap-config.json: yumidoexampleapp/src
  npm_scripts:
    - "npm run test"
  # Versioning
  version_major: 0
  version_minor: 0
  version_revision: $[counter(variables['version_minor'], 0)]
  # Docker Config
  docker_image_name: $(self_generic_name)
  docker_image_tag: "$(version_major).$(version_minor).$(version_revision)-$(build.sourcebranchname)"
  docker_container_registry_name: $(company)$(project)nonproduks$(domain)

steps:
  - checkout: self
  - checkout: templates
    persistCredentials: true

  - ${{ each config in variables.scaffolding_config }}:
    - template: steps/run-scaffolding-cli.yml
      parameters:
        # Docker Config
        docker_build_additional_args: "--build-arg CONFIG_FILENAME=${{ config.key }} --build-arg PROJECT_WORKDIR=${{ config.value }} ."
        docker_run_additional_args: $(npm_scripts)
        docker_workdir: "$(Agent.BuildDirectory)/s/$(self_repo)/$(self_repo_src)"
        docker_imagename: "$(docker_image_name)"
        docker_containerregistryname: "$(docker_container_registry_name)"
        docker_tag_args: "-t $(docker_container_registry_name)/$(docker_image_name):$(docker_image_tag) \
        -t $(docker_container_registry_name)/$(docker_image_name):latest"
        # Run scripts against built image
        build_container_image: true
        run_container_image: true
